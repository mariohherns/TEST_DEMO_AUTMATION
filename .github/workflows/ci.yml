name: CI

"on":
  push:
    branches: ["main"]
  pull_request:

jobs:
  backend_tests:
    name: Backend | Integration + System (SIT) | pytest
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: refinery
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U app -d refinery"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      APP_ENV: ci
      DATABASE_URL: postgresql+psycopg://app:app@localhost:5432/refinery
      JWT_SECRET: ci_secret
      JWT_EXPIRE_MIN: "120"
      CORS_ORIGINS: http://localhost:3000
      API_BASE: http://127.0.0.1:8000

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install backend deps
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install fastapi uvicorn
          pip install pytest httpx pytest-html

      - name: Start FastAPI (background) + wait
        working-directory: backend
        run: |
          nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
          echo "Waiting for backend..."
          for i in {1..60}; do
            if curl -sSf http://127.0.0.1:8000/docs >/dev/null 2>&1; then
              echo "Backend up!"
              break
            fi
            sleep 1
          done
          if ! curl -sSf http://127.0.0.1:8000/docs >/dev/null 2>&1; then
            echo "Backend did not start. Last 200 lines:"
            tail -n 200 uvicorn.log || true
            exit 1
          fi

      - name: Run backend tests (JUnit + HTML report)
        working-directory: backend
        run: |
          mkdir -p test-results backend/artifacts
          pytest -q app/tests \
            --junitxml=test-results/backend-junit.xml \
            --html=artifacts/backend_report.html --self-contained-html

      - name: Upload backend artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-artifacts
          path: |
            backend/uvicorn.log
            backend/test-results
            backend/artifacts

  ui_jest:
    name: UI | Unit + Integration Tests | Jest
    runs-on: ubuntu-latest
    needs: [backend_tests]

    env:
      NEXT_PUBLIC_API_BASE: http://127.0.0.1:8000

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install UI deps
        working-directory: ui
        run: |
          npm ci || npm install
          npm i -D jest-junit

      - name: Run Jest (JUnit report)
        working-directory: ui
        run: |
          mkdir -p test-results
          npm test -- --ci --verbose --reporters=default --reporters=jest-junit

      - name: Upload Jest artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-jest-artifacts
          path: |
            ui/test-results

  ui_smoke:
    name: UI | E2E Smoke Tests | Playwright (pytest)
    runs-on: ubuntu-latest
    needs: [backend_tests]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: refinery
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U app -d refinery"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      APP_ENV: ci
      DATABASE_URL: postgresql+psycopg://app:app@localhost:5432/refinery
      JWT_SECRET: ci_secret
      JWT_EXPIRE_MIN: "120"
      CORS_ORIGINS: http://localhost:3000,http://127.0.0.1:3000
      BASE_URL: http://127.0.0.1:3000
      NEXT_PUBLIC_API_BASE: http://127.0.0.1:8000
      API_BASE: http://127.0.0.1:8000

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install backend + UI test deps (Playwright)
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-html playwright pytest-playwright

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps chromium

      - name: Start FastAPI (background) + wait
        working-directory: backend
        run: |
          nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
          echo "Waiting for backend..."
          for i in {1..30}; do
            if curl -sSf http://127.0.0.1:8000/docs >/dev/null 2>&1; then
              echo "Backend up!"
              break
            fi
            sleep 1
          done
          if ! curl -sSf http://127.0.0.1:8000/docs >/dev/null 2>&1; then
            echo "Backend did not start. Last 200 lines:"
            tail -n 200 uvicorn.log || true
            exit 1
          fi

      - name: Install UI deps (cached)
        working-directory: ui
        run: npm ci

      - name: Build UI
        working-directory: ui
        env:
          NEXT_PUBLIC_API_BASE: http://127.0.0.1:8000
        run: npm run build

      - name: Start UI (background) + wait
        working-directory: ui
        env:
          NEXT_PUBLIC_API_BASE: http://127.0.0.1:8000
        run: |
          nohup npm run start -- -p 3000 > next.log 2>&1 &
          echo "Waiting for UI..."
          for i in {1..30}; do
            if curl -sSf http://127.0.0.1:3000/login >/dev/null 2>&1; then
              echo "UI up!"
              break
            fi
            sleep 1
          done
          if ! curl -sSf http://127.0.0.1:3000/login >/dev/null 2>&1; then
            echo "UI did not start. Last 200 lines:"
            tail -n 200 next.log || true
            exit 1
          fi

      - name: UI sanity check
        run: |
          curl -sSf http://127.0.0.1:3000/login | head -n 20

      - name: Run Playwright UI tests (JUnit + HTML report)
        run: |
          mkdir -p ui_tests/artifacts ui_tests/test-results
          pytest -q ui_tests/e2e/smoke \
            --junitxml=ui_tests/test-results/ui-e2e-junit.xml \
            --html=ui_tests/artifacts/ui_report.html --self-contained-html

      - name: Upload UI artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-e2e-artifacts
          path: |
            ui_tests/artifacts
            ui_tests/test-results
            ui_tests/artifacts
            backend/uvicorn.log
            ui/next.log
            test-results